# MOSHI Audio Investigation Summary

**Date Range**: 2025-11-06 to 2025-11-08
**Platform**: macOS 14.4, Apple M3 Max
**Issue**: MOSHI produces completely garbled/unintelligible audio output

## Problem Statement

MOSHI voice model (Rust/Candle implementation) generates garbled audio output on M3 Mac that is completely unintelligible to human listeners, despite:
- Successful model loading
- Normal-looking tensor operations
- Consistent output generation (byte-identical across runs)
- Whisper API reporting "successful" transcriptions (FALSE POSITIVES)

## Key Discoveries

### 1. Whisper API False Positives
**Finding**: OpenAI Whisper API hallucinates plausible transcriptions from garbled audio instead of failing gracefully.

**Evidence**:
- Test output: `tmp/moshi-response.wav` (completely garbled to human ears)
- Whisper transcription: "and I'll see you in the next video. Take care."
- User confirmation: "Ahh, that last audio is entirely garbled. That helps us pinpoint."

**Impact**: Cannot use Whisper API for automated audio quality validation.

### 2. Byte-Identical Garbled Output
**Finding**: Multiple "fix" attempts produced identical garbled output.

**Evidence**:
- All outputs have MD5: `4d49440e24fa4cf984df84d280e47413`
- Tested configurations:
  - v8.2: Separate encoder/decoder instances
  - v8.3: Ultra high-quality resampling (sinc_len=512, f_cutoff=0.99)
  - Multiple other resampling configurations

**Impact**: Bug is NOT in audio decode/resample step - must be in LM token generation or upstream in Candle Metal backend.

### 3. Candle 0.9.2-alpha.1 M3 Incompatibility
**Finding**: Candle Metal refactor crashes on M3 with "foreign exceptions"

**Error**: `fatal runtime error: Rust cannot catch foreign exceptions`
**When**: During MOSHI model initialization
**Impact**: Cannot test whether Metal refactor would fix garbled audio

**Details**: See `docs/CANDLE_092_ALPHA_CRASH_REPORT.md`

### 4. No Existing Bug Reports
**Finding**: Zero GitHub issues in MOSHI or Candle repositories matching our symptoms.

**Searched for**:
- "M-series garbled audio"
- "Apple Metal distorted audio"
- "M3 MOSHI unintelligible"
- "Candle Metal MOSHI"

**Result**: No matches - appears to be unreported bug

**Implication**: Either very specific to our setup, or M3 is too new/untested

### 5. Python MLX API Limitations
**Finding**: `moshi_mlx` Python package has NO programmatic API for testing.

**What exists**: Command-line interface only (`python -m moshi_mlx.local`)
**What's missing**: Direct Python API for `MimiModel`, `LMModel`, etc.
**Impact**: Cannot perform apples-to-apples comparison with Rust implementation

**Details**: See `docs/MOSHI_MLX_TEST_STATUS.md`

## Technical Details

### Hardware/Software Environment
```
Platform: macOS 14.4 (Darwin 23.4.0)
CPU: Apple M3 Max
GPU: Apple M3 Max (Metal)
Rust: 1.79.0 (via cargo)
Candle: 0.9.1 (Metal backend enabled)
MOSHI Models: kyutai/moshiko-pytorch-bf16, kyutai/mimi
```

### Consistent Test Setup
```
Input: ./tmp/test-user-hello.wav
  - 48000Hz sample rate
  - Synthetic voice saying "Hello"
  - Generated by our test harness

Output: ./tmp/moshi-response.wav
  - 24000Hz (MOSHI native rate)
  - Completely garbled/unintelligible
  - MD5: 4d49440e24fa4cf984df84d280e47413 (consistent)
```

### Tested Configurations
All produced identical garbled output:

1. **config_1_ultra_high_quality**
   - sinc_len: 512
   - f_cutoff: 0.99
   - Interpolation: Linear

2. **config_2_high_quality**
   - sinc_len: 256
   - f_cutoff: 0.95
   - Interpolation: Linear

3. **config_3_balanced**
   - sinc_len: 128
   - f_cutoff: 0.90
   - Interpolation: Linear

4. **config_4_fast**
   - sinc_len: 64
   - f_cutoff: 0.85
   - Interpolation: Nearest

## Root Cause Analysis

### What We Know
‚úÖ Bug is reproducible and consistent (byte-identical output)
‚úÖ Bug is NOT in audio decode/resample step (all configs produce same output)
‚úÖ Bug is likely in LM token generation or Candle Metal backend
‚úÖ Candle 0.9.2-alpha.1 is incompatible with M3 (crashes)
‚úÖ No other users have reported this (unique to our environment or M3)

### What We Don't Know
‚ùì Is it M3-specific or configuration-specific?
‚ùì Would CPU mode work? (not tested - user constraint: "CPU is not an option")
‚ùì Does Python MLX version work correctly? (blocked by API limitations)
‚ùì Is it a Candle bug, MOSHI bug, or M3 Metal driver issue?

## Constraints

- **User requirement**: "CPU is not an option" - must use Metal/GPU
- **Testing blocked**: Python MLX has no programmatic API for comparison
- **Candle upgrade blocked**: v0.9.2-alpha.1 crashes on M3

## Options Going Forward

### Option 1: Report to Candle Project ‚≠ê RECOMMENDED
**Why**: We have solid evidence and no existing reports

**What to report**:
1. MOSHI produces garbled audio on M3 with Candle 0.9.1 Metal
2. Candle 0.9.2-alpha.1 crashes with "foreign exceptions" on M3

**Evidence to provide**:
- Hardware specs (M3 Max)
- Software versions (Candle 0.9.1, MOSHI 0.6.4)
- Reproduction steps
- Sample garbled output WAV file
- MD5 checksums proving consistency
- Crash logs from v0.9.2-alpha.1

**Next steps**:
1. Create minimal reproduction case
2. File GitHub issue in `huggingface/candle`
3. Include all documentation from this investigation

### Option 2: Manual MLX Testing
**What**: Run `python -m moshi_mlx.local -q 4` interactively

**Pros**:
- Quick to test
- Subjective quality assessment

**Cons**:
- Not comparable to Rust test (different input)
- Doesn't isolate specific issue
- Subjective only

### Option 3: Deep Dive MLX Source
**What**: Clone MOSHI repo and create custom Python test script

**Pros**:
- Would enable direct comparison
- Could use same input file

**Cons**:
- Time-intensive
- May break between versions
- Relies on undocumented internal APIs

### Option 4: Wait for Upstream Fixes
**What**: Monitor Candle releases, test future versions

**Pros**:
- No effort required
- May get fixed naturally

**Cons**:
- Could wait indefinitely
- Problem may never be discovered without our report

## Recommendation

**üéØ RECOMMENDED ACTION: Option 1 - Report to Candle Project**

**Reasoning**:
1. We have comprehensive evidence and documentation
2. No existing reports - this is a novel discovery
3. User constraint (no CPU mode) means we need Metal to work
4. M3 is newer hardware - Candle team may not have tested thoroughly
5. Our findings could help other M3 users

**Preparation needed**:
- [ ] Create minimal reproduction repository
- [ ] Include test input/output WAV files
- [ ] Document exact steps to reproduce
- [ ] Include hardware/software specs
- [ ] Reference this investigation documentation

## Related Documentation

- [CANDLE_092_ALPHA_CRASH_REPORT.md](./CANDLE_092_ALPHA_CRASH_REPORT.md) - Crash report for v0.9.2-alpha.1
- [MOSHI_MLX_TEST_STATUS.md](./MOSHI_MLX_TEST_STATUS.md) - Python MLX testing attempt
- [MOSHI_AUDIO_SUMMARY.md](../MOSHI_AUDIO_SUMMARY.md) - Original investigation notes
- [tmp/moshi-response.wav](../tmp/moshi-response.wav) - Sample garbled output

## Timeline

- **2025-11-06**: Initial discovery of garbled audio
- **2025-11-07**: Multiple fix attempts (all byte-identical output)
- **2025-11-07**: Discovered Whisper false positive issue
- **2025-11-08**: Tested Candle 0.9.2-alpha.1 upgrade (crashes on M3)
- **2025-11-08**: Attempted Python MLX comparison (blocked by API)
- **2025-11-08**: Investigation summary complete

---

**Status**: READY TO REPORT TO UPSTREAM
**Awaiting**: User decision on next action
