# MOSHI Audio Debugging Status

## The Problem

**Audio output is completely garbled** - sounds like "crowd of people talking at once."

Both test mode WAV files and real-time conversation produce garbled audio.

## Fixes Attempted

### 1. Per-Connection MIMI Decoder State ❌ FAILED
**Hypothesis:** MIMI decoder needs persistent state across frames per connection.

**Implementation:** Cloned MIMI decoder for each connection/test (following moshi-server pattern).

**Result:** NO CHANGE - audio still garbled.

**User feedback:** "no change in voice. 2-second surges of garbled audio."

### 2. Batch Size Initialization (GitHub Issue #118) ❌ FAILED
**Hypothesis:** MIMI needs `batch_size=1` for streaming (from Python users with same issue).

**Implementation:** Changed from `moshi::mimi::load()` to `moshi::mimi::load_b(Some(1), ...)`.

**Result:** NEW ERROR - "batched-transformer expects a mask"

**Why it failed:** Python and Rust MIMI APIs are different. Rust with batch_size requires proper mask creation, not just `()`.

**Status:** REVERTED back to `load()`.

## What We Know

### ✅ Confirmed Facts
1. MIMI codebook count is correct (8, not 32)
2. Resampler configured with ultra-high quality
3. Whisper API successfully transcribes garbled audio (misleading indicator!)
4. Both test and real-time modes produce same garbled output
5. Audio generated by encode_step -> decode_step pipeline

### ❌ What Doesn't Work
1. Per-connection decoder cloning
2. Batch size initialization (without mask changes)
3. Using GitHub Issue #118 Python solution directly

### ❓ Unknown
1. Whether MOSHI Rust implementation actually works for real-time audio
2. If the garbling is in encode, decode, or both
3. Whether other Rust projects successfully use MOSHI for real-time audio
4. If there are Rust-specific MOSHI configuration requirements

## Next Investigation Areas

### Option A: Search for Working Rust Examples
Find other Rust projects using MOSHI successfully and compare their code.

### Option B: Test Encode/Decode Separately
- Generate test audio
- Encode to codes
- Decode codes
- Check if decode alone produces garbled audio

### Option C: Contact MOSHI Developers
File issue in kyutai-labs/moshi repo describing the problem with Rust implementation.

### Option D: Alternative Voice Model
Consider switching to a different voice model that has confirmed working Rust implementation.

## Questions for User

1. **Have you ever heard clear audio from MOSHI?** (Or has it always been garbled?)
2. **Are there other xSwarm users with working MOSHI audio?**
3. **Would you consider trying a different voice model?**
4. **Do you want me to file a detailed bug report with MOSHI developers?**

---

**Status:** Both attempted fixes failed. Need user input on next direction.

**Version:** 0.1.0-2025.11.7.2 (reverted batch_size changes)

**Date:** 2025-11-07
